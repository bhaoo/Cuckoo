/**
 * .______    __    __       ___        ______
 * |   _  \  |  |  |  |     /   \      /  __  \
 * |  |_)  | |  |__|  |    /  ^  \    |  |  |  |
 * |   _  <  |   __   |   /  /_\  \   |  |  |  |
 * |  |_)  | |  |  |  |  /  _____  \  |  `--'  |
 * |______/  |__|  |__| /__/     \__\  \______/
 *
 * Comments's JavaScript
 *
 * @author Bhao
 * @link https://dwd.moe/
 * @date 2023-07-19
 */

var Comments={data:{},config:{cancelReplyBtnID:"#sendComment-title-reply-button",owoDialogButtonID:"#sendComment-title-owo-button",owoInputButtonID:"#sendComment-input-owo-button",},Core:function(){var commentID=$('.comment-respond').attr('id');window.TypechoComment={dom:function(id){return document.getElementById(id);},create:function(tag,attr){var el=document.createElement(tag);for(var key in attr){el.setAttribute(key,attr[key]);};return el;},reply:function(cid,coid){var comment=this.dom(cid),parent=comment.parentNode,response=this.dom(commentID),input=this.dom('comment-parent'),form='form'===response.tagName?response:response.getElementsByTagName('form')[0],textarea=response.getElementsByTagName('textarea')[0];if(null==input){input=this.create('input',{'type':'hidden','name':'parent','id':'comment-parent'});form.appendChild(input);};input.setAttribute('value',coid);if(null==this.dom('comment-form-place-holder')){var holder=this.create('div',{'id':'comment-form-place-holder'});response.parentNode.insertBefore(holder,response);};comment.appendChild(response);this.dom('cancel-comment-reply-link').style.display='';if(null!=textarea&&'text'==textarea.name){textarea.focus();};return false;},cancelReply:function(){var response=this.dom(commentID),holder=this.dom('comment-form-place-holder'),input=this.dom('comment-parent');if(null!=input){input.parentNode.removeChild(input);};if(null==holder){return true;};this.dom('cancel-comment-reply-link').style.display='none';holder.parentNode.insertBefore(response,holder);$(Comments.config.owoDialogButtonID)[0].style.display="inline-block";if(Comments.config.owoInputButtonID!=""){$(Comments.config.owoInputButtonID)[0].style.display="none";};return false;}}},submit(){if(!$('.comment-respond').attr('data-commentUrl')){return false;};if(!$(".comment-textarea").val()){mdui.snackbar({message:'评论内容不能为空',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});return false;};if($(".comment-input-author").length&&!$(".comment-input-author").val()){mdui.snackbar({message:'昵称不能为空',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});return false;};if($(".comment-input-email").length&&!$(".comment-input-email").val()){mdui.snackbar({message:'邮箱不能为空',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});return false;};function beforeComment(){$('button.submit').attr('disabled',true);if($('.comment-respond input').length){$('.comment-respond input').attr('readonly',true);};$('.comment-respond textarea').attr('readonly',true);};beforeComment();function afterComment(status){$('button.submit').removeAttr('disabled');if($('.comment-respond input').length){$('.comment-respond input').removeAttr('readonly');};$('.comment-respond textarea').removeAttr('readonly');if(status){$(".comment-textarea").val("");$(".comment-textarea")[0].focus();$(".comment-textarea")[0].blur();mdui.snackbar({message:'评论成功啦！(｡･∀･)ﾉﾞ',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-green-600')}});}else{console.log("评论后处理函数：评论失败啦！")};Comments.bindReplyBtn();};$.ajax({method:'POST',url:$('.comment-respond').attr('data-commentUrl'),data:$('#comment-form').serialize(),success:function(data){var Obj=$(document.createElement('body')).append(data);if($(Obj)[0].querySelector('.container')==null){var $htmlData=$(document.createElement('body')).append(data);if($htmlData.html()){Comments.data.NewID=$htmlData.html().match(/id=\"?comment-\d+/g).join().match(/\d+/g).sort(function(a,b){return a-b}).pop();}else{mdui.snackbar({message:'出现错误，请刷新页面再进行评论',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});afterComment(false);return false;};if(Comments.data.replyTo===''||Comments.data.replyTo===null){Comments.data.newComment=$htmlData[0].querySelectorAll('#comment-'+Comments.data.NewID);if(!$(".comments-container > .comment-card").length){$('.comments-container').html("");$('.comments-container').first().prepend(Comments.data.newComment);$('#comment-'+Comments.data.NewID).addClass('animation-fadein');}else{$('.comments-container').first().prepend(Comments.data.newComment);};$('#comment-'+Comments.data.NewID).addClass('animation-fadein');}else{Comments.data.newComment=$htmlData[0].querySelectorAll('#comment-'+Comments.data.NewID);if($('#'+Comments.data.replyTo).find('.comment-children').length){$('#'+Comments.data.replyTo+' .comment-children').first().append(Comments.data.newComment);}else{$('#'+Comments.data.replyTo).append('<div class="comment-children"></div>');$('#'+Comments.data.replyTo+' .comment-children').first().append(Comments.data.newComment);};TypechoComment.cancelReply();$('#comment-'+Comments.data.NewID).addClass('animation-fadein');};afterComment(true);}else{afterComment(false);mdui.snackbar({message:$(Obj)[0].querySelector('.container').innerHTML,position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});}},error:function(xhr,status,error){mdui.snackbar({message:'评论提交失败！原因 [HTTP '+xhr.status+']',position:'right-bottom',onOpen:function(){document.querySelector('.mdui-snackbar').classList.add('mdui-color-red-400')}});afterComment(false);}});},bindReplyBtn:function(){Comments.data.replyTo='';if(!$(".comment-reply-box a")[0]){return false;};for(let i=0;i<$(".comment-reply-box a").length;++i){$(".comment-reply-box a")[i].addEventListener('click',function(){Comments.data.replyTo=$(this).parent().parent().attr('id');$(Comments.config.owoDialogButtonID)[0].style.display="none";if(Comments.config.owoInputButtonID!=""){$(Comments.config.owoInputButtonID)[0].style.display="inline-block";}});};$(Comments.config.cancelReplyBtnID).on("click",function(){Comments.data.replyTo='';$(Comments.config.owoDialogButtonID)[0].style.display="inline-block";if(Comments.config.owoInputButtonID!=""){$(Comments.config.owoInputButtonID)[0].style.display="none";}});}};Comments.Core();Comments.bindReplyBtn();